<!-- Mermaid 다이어그램 지원 -->
<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
  
  // 사이트 색상 체계에 맞는 커스텀 테마 설정
  const siteThemeVariables = {
    // 기본 색상 (사이트 CSS 변수와 매칭)
    primaryColor: '#667eea',
    primaryTextColor: '#ffffff',
    primaryBorderColor: '#5a67d8',
    
    secondaryColor: '#764ba2',
    secondaryTextColor: '#ffffff',
    secondaryBorderColor: '#6b46c1',
    
    tertiaryColor: '#f093fb',
    tertiaryTextColor: '#1a202c',
    tertiaryBorderColor: '#e879f9',
    
    // 배경 및 표면
    background: '#ffffff',
    mainBkg: '#f7fafc',
    secondaryBkg: '#e2e8f0',
    tertiaryBkg: '#fed7e2',
    
    // 텍스트 색상
    textColor: '#2d3748',
    lineColor: '#cbd5e0',
    
    // 특별한 색상들
    noteBkgColor: '#ebf8ff',
    noteTextColor: '#2d3748',
    noteBorderColor: '#667eea',
    
    // 폰트 설정
    fontFamily: 'Inter, -apple-system, BlinkMacSystemFont, sans-serif',
    fontSize: '14px',
    
    // 플로우차트 전용
    nodeBorder: '#5a67d8',
    clusterBkg: '#fed7e2',
    clusterBorder: '#e879f9',
    defaultLinkColor: '#667eea',
    titleColor: '#2d3748',
    nodeTextColor: '#2d3748',
    
    // 시퀀스 다이어그램
    actorBkg: 'linear-gradient(135deg, #667eea, #764ba2)',
    actorBorder: '#5a67d8',
    actorTextColor: '#ffffff',
    signalColor: '#667eea',
    signalTextColor: '#2d3748',
    
    // 간트 차트
    gridColor: '#e2e8f0',
    section0: '#667eea',
    section1: '#764ba2',
    section2: '#f093fb',
    section3: '#4ade80',
    
    // 파이 차트
    pie1: '#667eea',
    pie2: '#764ba2', 
    pie3: '#f093fb',
    pie4: '#4ade80',
    pie5: '#fbbf24',
    pie6: '#f87171',
    pie7: '#a78bfa',
    pie8: '#34d399',
    pie9: '#60a5fa',
    pie10: '#fb7185',
    pie11: '#c084fc',
    pie12: '#22d3ee'
  };

  // 다크모드 감지 함수
  const detectDarkMode = () => {
    return window.matchMedia('(prefers-color-scheme: dark)').matches || 
           document.documentElement.getAttribute('data-theme') === 'dark' ||
           document.body.classList.contains('dark') ||
           document.documentElement.classList.contains('dark');
  };

  // 테마에 따른 변수 설정 함수
  const getThemeVariables = (isDark) => {
    const baseVariables = {
      // 투명 배경 설정
      background: 'transparent',
      mainBkg: 'transparent',
      
      // 폰트 설정
      fontFamily: 'Inter, -apple-system, BlinkMacSystemFont, sans-serif',
      fontSize: '14px',
    };

    if (isDark) {
      return {
        ...baseVariables,
        // 다크모드 색상
        primaryColor: '#8b7cf8',
        primaryTextColor: '#f7fafc',
        primaryBorderColor: '#7c3aed',
        
        secondaryColor: '#a78bfa',
        secondaryTextColor: '#f7fafc',
        secondaryBorderColor: '#8b5cf6',
        
        tertiaryColor: '#fbbf24',
        tertiaryTextColor: '#1a202c',
        tertiaryBorderColor: '#f59e0b',
        
        // 배경과 표면 (투명/반투명)
        secondaryBkg: 'rgba(79, 70, 229, 0.1)',
        tertiaryBkg: 'rgba(168, 85, 247, 0.1)',
        
        // 텍스트 색상 (다크모드)
        textColor: '#f7fafc',
        lineColor: '#6b7280',
        
        // 노트 색상
        noteBkgColor: 'rgba(59, 130, 246, 0.15)',
        noteTextColor: '#f7fafc',
        noteBorderColor: '#3b82f6',
        
        // 플로우차트
        nodeBorder: '#8b7cf8',
        clusterBkg: 'rgba(168, 85, 247, 0.1)',
        clusterBorder: '#a78bfa',
        defaultLinkColor: '#8b7cf8',
        titleColor: '#f7fafc',
        nodeTextColor: '#1a202c',
        
        // 시퀀스 다이어그램
        actorBkg: 'rgba(139, 124, 248, 0.2)',
        actorBorder: '#8b7cf8',
        actorTextColor: '#f7fafc',
        signalColor: '#8b7cf8',
        signalTextColor: '#f7fafc',
        
        // 간트 차트
        gridColor: '#4b5563',
        section0: '#8b7cf8',
        section1: '#a78bfa',
        section2: '#fbbf24',
        section3: '#34d399',
        
        // 파이 차트
        pie1: '#8b7cf8',
        pie2: '#a78bfa',
        pie3: '#fbbf24',
        pie4: '#34d399',
        pie5: '#f87171',
        pie6: '#60a5fa',
        pie7: '#c084fc',
        pie8: '#22d3ee',
        pie9: '#fb7185',
        pie10: '#4ade80',
        pie11: '#818cf8',
        pie12: '#f472b6'
      };
    } else {
      return {
        ...baseVariables,
        // 라이트모드 색상
        primaryColor: '#667eea',
        primaryTextColor: '#ffffff',
        primaryBorderColor: '#5a67d8',
        
        secondaryColor: '#764ba2',
        secondaryTextColor: '#ffffff',
        secondaryBorderColor: '#6b46c1',
        
        tertiaryColor: '#f093fb',
        tertiaryTextColor: '#1a202c',
        tertiaryBorderColor: '#e879f9',
        
        // 배경과 표면 (투명/반투명)
        secondaryBkg: 'rgba(102, 126, 234, 0.1)',
        tertiaryBkg: 'rgba(240, 147, 251, 0.1)',
        
        // 텍스트 색상 (라이트모드)
        textColor: '#2d3748',
        lineColor: '#cbd5e0',
        
        // 노트 색상
        noteBkgColor: 'rgba(102, 126, 234, 0.1)',
        noteTextColor: '#2d3748',
        noteBorderColor: '#667eea',
        
        // 플로우차트
        nodeBorder: '#5a67d8',
        clusterBkg: 'rgba(240, 147, 251, 0.1)',
        clusterBorder: '#e879f9',
        defaultLinkColor: '#667eea',
        titleColor: '#2d3748',
        nodeTextColor: '#1a202c',
        
        // 시퀀스 다이어그램
        actorBkg: 'rgba(102, 126, 234, 0.15)',
        actorBorder: '#5a67d8',
        actorTextColor: '#1a202c',
        signalColor: '#667eea',
        signalTextColor: '#2d3748',
        
        // 간트 차트
        gridColor: '#e2e8f0',
        section0: '#667eea',
        section1: '#764ba2',
        section2: '#f093fb',
        section3: '#4ade80',
        
        // 파이 차트
        pie1: '#667eea',
        pie2: '#764ba2',
        pie3: '#f093fb',
        pie4: '#4ade80',
        pie5: '#fbbf24',
        pie6: '#f87171',
        pie7: '#a78bfa',
        pie8: '#34d399',
        pie9: '#60a5fa',
        pie10: '#fb7185',
        pie11: '#c084fc',
        pie12: '#22d3ee'
      };
    }
  };

  // 초기 테마 감지 및 변수 설정
  let isDarkMode = detectDarkMode();
  let themeVariables = getThemeVariables(isDarkMode);

  // Mermaid 초기화 함수
  const initializeMermaid = (themeVars) => {
    mermaid.initialize({ 
      startOnLoad: true,
      theme: 'base',
      securityLevel: 'loose',
      fontFamily: 'Inter, -apple-system, BlinkMacSystemFont, sans-serif',
      themeVariables: themeVars,
      
      // 각 다이어그램별 세부 설정
      flowchart: {
        curve: 'basis',
        padding: 20
      },
      
      sequence: {
        diagramMarginX: 50,
        diagramMarginY: 10,
        actorMargin: 50,
        width: 150,
        height: 65,
        boxMargin: 10,
        boxTextMargin: 5,
        noteMargin: 10,
        messageMargin: 35
      },
      
      gantt: {
        numberSectionStyles: 4,
        axisFormat: '%m/%d',
        gridLineStartPadding: 350,
        fontSize: 11,
        sectionFontSize: 12,
        bottomPadding: 25,
        leftPadding: 75,
        rightPadding: 50
      }
    });
  };

  // 초기 Mermaid 설정
  initializeMermaid(themeVariables);

  // 테마 변경 감지 및 다이어그램 다시 렌더링
  const handleThemeChange = async () => {
    const newIsDarkMode = detectDarkMode();
    if (newIsDarkMode !== isDarkMode) {
      isDarkMode = newIsDarkMode;
      themeVariables = getThemeVariables(isDarkMode);
      
      // Mermaid 재초기화
      initializeMermaid(themeVariables);
      
      // 기존 다이어그램 다시 렌더링
      const mermaidElements = document.querySelectorAll('.mermaid');
      for (const element of mermaidElements) {
        if (element.getAttribute('data-processed')) {
          element.removeAttribute('data-processed');
          const originalText = element.getAttribute('data-original-text');
          if (originalText) {
            element.textContent = originalText;
            await mermaid.run({
              querySelector: `#${element.id || Math.random().toString(36).substr(2, 9)}`,
              nodes: [element]
            });
          }
        }
      }
    }
  };

  // 테마 변경 감지를 위한 이벤트 리스너
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', handleThemeChange);
  
  // DOM 변경 감지 (data-theme 속성 변경 등)
  const themeObserver = new MutationObserver(handleThemeChange);
  themeObserver.observe(document.documentElement, { 
    attributes: true, 
    attributeFilter: ['data-theme', 'class'] 
  });
  themeObserver.observe(document.body, { 
    attributes: true, 
    attributeFilter: ['class'] 
  });
  
  // 페이지 로드 완료 후 실행
  document.addEventListener('DOMContentLoaded', async function() {
    // .language-mermaid 클래스를 가진 코드 블록 찾기
    const mermaidBlocks = document.querySelectorAll('pre > code.language-mermaid');
    
    // 각 코드 블록을 mermaid 클래스 pre 태그로 변환
    mermaidBlocks.forEach((codeBlock) => {
      const preElement = codeBlock.parentElement;
      const mermaidContent = codeBlock.textContent;
      
      // 새로운 pre 요소 생성
      const newPre = document.createElement('pre');
      newPre.className = 'mermaid';
      newPre.textContent = mermaidContent;
      
      // 기존 요소를 새 요소로 교체
      preElement.parentNode.replaceChild(newPre, preElement);
    });
    
    // Mermaid 렌더링 실행
    await mermaid.run({
      querySelector: '.mermaid',
    });
  });
</script>

<!-- Mermaid 다이어그램 스타일 최적화 -->
<style>
  .mermaid {
    text-align: center;
    margin: 2rem 0;
    background: transparent;
    border: none;
    overflow: visible;
    padding: 1.5rem;
    border-radius: var(--radius-lg, 0.75rem);
    transition: var(--transition, all 0.3s ease);
    position: relative;
  }
  
  /* 라이트모드 배경 */
  .mermaid {
    border: 1px solid var(--border, rgba(102, 126, 234, 0.2));
    box-shadow: 0 2px 8px var(--shadow, rgba(102, 126, 234, 0.1));
  }
  
  .mermaid:hover {
    box-shadow: 0 4px 16px var(--shadow, rgba(102, 126, 234, 0.15));
    border-color: var(--primary-color, #667eea);
    transform: translateY(-1px);
  }
  
  .mermaid svg {
    max-width: 100%;
    height: auto;
    display: block;
    margin: 0 auto;
    font-family: var(--font-family, 'Inter', -apple-system, BlinkMacSystemFont, sans-serif);
  }
  
  /* 다이어그램 제목 스타일링 */
  .mermaid .titleText {
    font-weight: 600;
    font-size: 1.25rem;
    fill: var(--text-primary, #2d3748);
    font-family: var(--font-family, 'Inter', sans-serif);
  }
  
  /* 노드 그라데이션 스타일 */
  .mermaid .node rect,
  .mermaid .node circle,
  .mermaid .node polygon {
    fill: url(#siteGradient);
    stroke: var(--primary-color, #667eea);
    stroke-width: 2px;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
  }
  
  /* 그라데이션 정의 */
  .mermaid svg defs {
    background: transparent;
  }
  
  /* 화살표와 연결선 스타일 */
  .mermaid .edgePath path,
  .mermaid .edgePath line {
    stroke: var(--primary-color, #667eea);
    stroke-width: 2px;
  }
  
  .mermaid .arrowheadPath {
    fill: var(--primary-color, #667eea);
    stroke: var(--primary-color, #667eea);
  }
  
  /* 텍스트 스타일 */
  .mermaid .nodeLabel,
  .mermaid .edgeLabel {
    font-family: var(--font-family, 'Inter', sans-serif);
    font-weight: 500;
    font-size: 14px;
  }
  
  /* 다크모드 대응 */
  [data-theme="dark"] .mermaid,
  .dark .mermaid {
    border: 1px solid rgba(139, 124, 248, 0.3);
    box-shadow: 0 2px 8px rgba(139, 124, 248, 0.1);
  }
  
  [data-theme="dark"] .mermaid:hover,
  .dark .mermaid:hover {
    box-shadow: 0 4px 16px rgba(139, 124, 248, 0.2);
    border-color: #8b7cf8;
  }
  
  [data-theme="dark"] .mermaid .titleText,
  .dark .mermaid .titleText {
    fill: #f7fafc;
  }
  
  @media (prefers-color-scheme: dark) {
    .mermaid {
      border: 1px solid rgba(139, 124, 248, 0.3);
      box-shadow: 0 2px 8px rgba(139, 124, 248, 0.1);
    }
    
    .mermaid:hover {
      box-shadow: 0 4px 16px rgba(139, 124, 248, 0.2);
      border-color: #8b7cf8;
    }
    
    .mermaid .titleText {
      fill: #f7fafc;
    }
  }
  
  /* 반응형 대응 */
  @media (max-width: 768px) {
    .mermaid {
      margin: 1.5rem 0;
      padding: 0.75rem;
      font-size: 0.9rem;
    }
    
    .mermaid svg {
      font-size: 12px;
    }
  }
  
  /* 인쇄용 스타일 */
  @media print {
    .mermaid {
      box-shadow: none;
      border: 1px solid #ccc;
      background: white;
    }
    
    .mermaid:hover {
      transform: none;
      box-shadow: none;
    }
  }
  
  /* 접근성 개선 */
  @media (prefers-reduced-motion: reduce) {
    .mermaid {
      transition: none;
    }
    
    .mermaid:hover {
      transform: none;
    }
  }
</style>

<!-- 테마별 그라데이션을 Mermaid에 적용하기 위한 SVG 정의 -->
<script type="module">
  // DOM 로드 후 그라데이션 정의 추가
  document.addEventListener('DOMContentLoaded', function() {
    const addThemeGradientToMermaid = () => {
      const mermaidElements = document.querySelectorAll('.mermaid svg');
      const currentIsDark = detectDarkMode();
      
      mermaidElements.forEach(svg => {
        // 기존 그라데이션 제거
        const existingGradient = svg.querySelector('#siteGradient');
        if (existingGradient) {
          existingGradient.remove();
        }
        
        // defs 요소 생성 또는 가져오기
        let defs = svg.querySelector('defs');
        if (!defs) {
          defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
          svg.insertBefore(defs, svg.firstChild);
        }
        
        // 테마에 따른 그라데이션 정의
        const gradient = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
        gradient.setAttribute('id', 'siteGradient');
        gradient.setAttribute('x1', '0%');
        gradient.setAttribute('y1', '0%');
        gradient.setAttribute('x2', '100%');
        gradient.setAttribute('y2', '100%');
        
        const stop1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
        const stop2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
        
        stop1.setAttribute('offset', '0%');
        stop2.setAttribute('offset', '100%');
        
        if (currentIsDark) {
          // 다크모드 그라데이션
          stop1.setAttribute('stop-color', '#8b7cf8');
          stop2.setAttribute('stop-color', '#a78bfa');
        } else {
          // 라이트모드 그라데이션
          stop1.setAttribute('stop-color', '#667eea');
          stop2.setAttribute('stop-color', '#764ba2');
        }
        
        gradient.appendChild(stop1);
        gradient.appendChild(stop2);
        defs.appendChild(gradient);
      });
    };
    
    // Mermaid 렌더링 완료 후 그라데이션 적용
    setTimeout(addThemeGradientToMermaid, 500);
    
    // 동적으로 생성되는 다이어그램에도 적용
    const gradientObserver = new MutationObserver(addThemeGradientToMermaid);
    gradientObserver.observe(document.body, { childList: true, subtree: true });
    
    // 테마 변경 시 그라데이션 업데이트
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', addThemeGradientToMermaid);
    
    // data-theme 속성 변경 감지
    const themeGradientObserver = new MutationObserver(addThemeGradientToMermaid);
    themeGradientObserver.observe(document.documentElement, { 
      attributes: true, 
      attributeFilter: ['data-theme', 'class'] 
    });
    themeGradientObserver.observe(document.body, { 
      attributes: true, 
      attributeFilter: ['class'] 
    });
  });
</script> 